[scenario]
ambient_light="color_transition(hour*60+minute,0,rgb(0,0,50),
											5*60,rgb(0,0,55),
											6*60,rgb(25,35,50),
											7*60,rgb(0,60,100),
											12*60,rgb(40,70,100),
											17*60,rgb(0,60,100),
											18*60,rgb(15,10,50),
											19*60,rgb(10,0,55),
											24*60,rgb(0,0,50))"
border_tile="0 h"
hours="9"
map="data/maps/felson"
party_light="rgb(100,100,100)"
party_light_power="if(hour < 6 or hour >= 18, 10, 0)"
sun_light="color_transition(hour*60+minute,0,rgb(0,0,0),
										6*60,rgb(0,0,0),
										7*60,rgb(100,100,0),
										12*60,rgb(100,100,85),
										17*60,rgb(100,80,0),
										18*60,rgb(0,0,0),
										24*60,rgb(0,0,0))"
	[exit]
	formula="x <= 12 or y <= 16 or x >= 31 or y >= 37"
	xdst="34"
	ydst="49"
	[/exit]
	[event]
	event="start"
	first_time_only="yes"
		[dialog]
		npc=pc
		text="After many days of travelling, I finally arrived at the town of Felson. There were reports of the town being attacked by monsters, and I had been sent by my captain to investigate."
		[/dialog]
		[scripted_moves]
		filter="id = 'harold'"
			[loc]
			x="16"
			y="23"
			[/loc]
		[/scripted_moves]
		[scripted_moves]
		filter="id = 'sal'"
			[loc]
			x="17"
			y="22"
			[/loc]
		[/scripted_moves]
		[scripted_moves]
		filter="id = 'blake'"
			[loc]
			x="18"
			y="22"
			[/loc]
		[/scripted_moves]
		[execute_script]
		script="start_script"
		[/execute_script]
	[/event]
	[event]
	event=finish_script
	filter="script = 'start_script'"
		[dialog]
		npc="head(filter(world.parties, id = 'harold'))"
		text="Halt stranger! No-one is allowed to enter our town!"
			[option]
			text="Relax, citizens, I am here to help."
				[dialog]
				npc="head(filter(world.parties, id = 'harold'))"
				text="Who are you? How can you possibly help? We are besieged by all manner of enemies!"
					[option]
					text="I am an officer of the royal army, sent here to investigate these very problems."

						[dialog]
						npc="head(filter(world.parties, id = 'harold'))"
						text="Oh, so the royal army has finally taken notice of our many problems? And sent you, one soldier to help? Well, come on in and show us what you can do, I suppose."
						[/dialog]
					[/option]
				[/dialog]
			[/option]
			[option]
			text="Why not? What is wrong?"
				[dialog]
				npc="head(filter(world.parties, id = 'harold'))"
				text="There are monsters and other hostiles wandering our lands. We are scared to wander outside of our town. If this continues for much longer it will be winter, and we will have no food!"
					[option]
					text="I am here to help. I am an officer of the royal army, sent here to investigate these problems"
						[dialog]
						npc="head(filter(world.parties, id = 'harold'))"
						text="Oh, so the royal army has finally taken notice of our many problems? And sent you, one soldier to help? Well, come on in and show us what you can do, I suppose."
						[/dialog]
					[/option]
				[/dialog]
			[/option]
			[option]
			text="I am here under authority of the royal seal. Let me in!"
				[dialog]
				npc="head(filter(world.parties, id = 'harold'))"
				text="Oh, so the royal army has finally taken notice of our many problems? And sent you, one soldier to help? Well, come on in and show us what you can do, I suppose."
				[/dialog]
			[/option]
		[/dialog]
		[modify_objects]
		objects="filter(world.parties, id = 'harold')"
		destination=loc(16,27)
		[/modify_objects]
		[modify_objects]
		objects="filter(world.parties, id = 'sal')"
		destination=loc(21,29)
		[/modify_objects]
		[modify_objects]
		objects="filter(world.parties, id = 'blake')"
		destination=loc(23,22)
		[/modify_objects]
	[/event]
	[party]
	aggressive="no"
	allegiance="good"
	controller="human"
	model="talin.3ds"
	money="20"
	x="16"
	y="21"
		[character]
		alignment="lawful"
		bar_portrait="portraits/talin-bar.png"
		description="Talin"
		equipment="short_sword,shield_slot,armor_slot"
		improvement_points="20"
		level="1"
		model="talin.3ds"
		portrait="portraits/talin.png"
			[attributes]
			agility="8"
			endurance="8"
			intelligence="8"
			perception="8"
			persona="8"
			strength="8"
			[/attributes]
		[/character]
	[/party]
	[party]
	aggressive="no"
	allegiance="good"
	id="harold"
	image="units/peasant.png"
	x="16"
	y="27"
		[character]
		alignment="Lawful"
		attack="12"
		climbing="1"
		damage="5"
		defense="9"
		description="Harold"
		hitpoints="10"
		initiative="5"
		max_hitpoints="10"
		portrait="portraits/peasant.png"
		speed="20"
		stamina="600"
		vision="10"
			[attributes]
			agility="8"
			endurance="8"
			intelligence="8"
			perception="8"
			persona="8"
			strength="8"
			[/attributes]
		[/character]
		[encounter]
			[dialog]
			text="Welcome to Felson.
As a new adventurer, you might want to go to the status screen by pressing s.
There you can build your character by assigning attributes and skills."
			[/dialog]
		[/encounter]
	[/party]
	[party]
	aggressive="no"
	allegiance="good"
	id="sal"
	image="units/townsman.png"
	x="21"
	y="29"
		[character]
		alignment="Lawful"
		attack="12"
		climbing="1"
		damage="5"
		defense="9"
		description="Sal"
		hitpoints="10"
		initiative="5"
		max_hitpoints="10"
		portrait="portraits/peasant.png"
		speed="20"
		stamina="600"
		vision="10"
			[attributes]
			agility="8"
			endurance="8"
			intelligence="8"
			perception="8"
			persona="8"
			strength="8"
			[/attributes]
		[/character]
		[encounter]
			[dialog]
			text="I'm a merchant who trades in weapons.
Look over my wares and see if there is anything you would like to purchase."
			[/dialog]
			[shop]
			cost="140 - pc.haggle"
			items="short_bow,short_sword,long_sword,shield,leather_armor"
			[/shop]
		[/encounter]
	[/party]

	[party]
	aggressive="no"
	allegiance="good"
	id="blake"
	image="units/townsman.png"
	x="23"
	y="22"
		[character]
		alignment="Lawful"
		attack="12"
		climbing="1"
		damage="5"
		defense="9"
		description="Blake"
		hitpoints="10"
		initiative="5"
		max_hitpoints="10"
		portrait="portraits/peasant.png"
		speed="20"
		stamina="600"
		vision="10"
			[attributes]
			agility="8"
			endurance="8"
			intelligence="8"
			perception="8"
			persona="8"
			strength="8"
			[/attributes]
		[/character]
		[encounter]
			[if]
			condition="filter(pc.members, hp < max_hp)"
				[then]
					[modify_objects]
					objects="var"
					tmp_heal_cost="sum(map(pc.members, max_hp - hp))/4 + 1"
					[/modify_objects]
					[if]
					condition="pc.money < tmp_heal_cost"
						[then]
							[dialog]
							text="I am the village healer. It would cost {var.tmp_heal_cost} trinka for me to heal your wounds, but it seems you don't have enough money."
							[/dialog]
						[/then]
						[else]
							[dialog]
							text="I am the village healer. I will heal your wounds for {var.tmp_heal_cost} trinka"
								[option]
								text="Sounds reasonable, do your stuff!"
									[modify_objects]
									hp="object.max_hp"
									objects="pc.members"
									[/modify_objects]
									[modify_objects]
									money="pc.money - var.tmp_heal_cost"
									objects="pc"
									[/modify_objects]
								[/option]
								[option]
								text="I think I'll go elsewhere."
								[/option]
							[/dialog]
						[/else]
					[/if]
				[/then]
				[else]
					[dialog]
					text="I am the village healer. You look like you're in good health at the moment, but do come back if you sustain injury."
					[/dialog]
				[/else]
			[/if]
		[/encounter]
	[/party]
	[party]
	aggressive="no"
	allegiance="good"
	image="units/peasant.png"
	x="26"
	y="30"
		[character]
		alignment="lawful"
		description="Milo"
		id="peasant"
		image="units/peasant.png"
		level="1"
		portrait="portraits/peasant.png"
			[attributes]
			agility="8"
			endurance="8"
			intelligence="8"
			perception="8"
			persona="8"
			strength="8"
			[/attributes]
		[/character]
		[dialog]
			[talk]
			message="There is a town to the South called Telfa, but we have not heard from them in months; the way is blocked by goblins"
			[/talk]
		[/dialog]
		[wander]
		x="25"
		y="28"
		[/wander]
		[wander]
		x="23"
		y="32"
		[/wander]
		[wander]
		x="21"
		y="25"
		[/wander]
		[wander]
		x="27"
		y="28"
		[/wander]
		[wander]
		x="26"
		y="33"
		[/wander]
	[/party]
	[party]
	aggressive="no"
	allegiance="good"
	image="units/vurgans.png"
	x="29"
	y="27"
		[character]
		alignment="lawful"
		bar_portrait="portraits/vurgans-bar.png"
		description="Vurgans"
		equipment="sabre,shield_slot,armor_slot"
		image="units/vurgans.png"
		level="2"
		portrait="portraits/Vurgans.png"
		skills="swordsmanship,fencing"
			[attributes]
			agility="15"
			endurance="14"
			intelligence="9"
			perception="10"
			persona="8"
			strength="10"
			[/attributes]
		[/character]
		[encounter]
			[dialog]
			text="My name is Vurgans. I want to fight evil, but will only join a party that has something to teach me."
				[option]
				text="How can I prove that I can teach you?"
					[dialog]
					text="If you defeat me in combat, I will join you."
						[option]
						text="[persona] Oh come now, surely there is much more you have to learn than simple combat."
							[if]
							condition="pc.leader.persona >= 10"
								[then]
									[dialog]
									text="Yes, you're right; I will join you and see what I can learn along the way."
									[/dialog]
									[modify_objects]
									members="pc.members + npc.members"
									objects="pc"
									[/modify_objects]
									[modify_objects]
									members="[]"
									objects="npc"
									[/modify_objects]
								[/then]
								[else]
									[dialog]
									text="Hah! You will have to do better than that to convince me! Come back when you are ready to use your sword, not your tongue."
									[/dialog]
								[/else]
							[/if]
						[/option]
						[option]
						text="Let us fight then, boy."
							[battle]
								[onvictory]
									[talk]
									message="You won. I acknowledge your skill, and will follow you."
									[/talk]
									[modify_objects]
									members="pc.members + npc.members"
									objects="pc"
									[/modify_objects]
									[modify_objects]
									members="[]"
									objects="npc"
									[/modify_objects]
								[/onvictory]
								[ondefeat]
									[talk]
									message="Try again later, if you learn a new trick.  At least it's good exercise..."
									[/talk]
								[/ondefeat]
							[/battle]
							[modify_objects]
							hitpoints="object.max_hitpoints"
							objects="pc.members + npc.members"
							[/modify_objects]
						[/option]
						[option]
						text="If I fought you, you would be dead by the end of it, boy."
						[/option]
					[/dialog]
				[/option]
				[option]
				text="I have no need of some 'student' following me around!"
				[/option]
			[/dialog]
		[/encounter]
	[/party]
[/scenario]
